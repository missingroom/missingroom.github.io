---
title: P7126 [Ynoi2008] rdCcot
tags: 数据结构 平衡树 点分治
---

卡常卡不动了，92 分，来写个题解。

本题的问题等价于将一个点和所有距离小于等于 $C$ 的点连边，求区间连通块数，但显然并不是所有边都有用，我们有个 naive 的想法，我们只用记录他连的所有边中和它编号最接近的两条就能保证连通行。预处理出和每个节点编号最接近的距离在 $C$ 以内的两个（一个大于 $x$，一个小于 $x$）节点，然后莫队并查集，于是你写了，过样例了，交了，WA 了。

冷静思考一下可以发现这种做法是显然错误的，我们注意到我们 $2n$ 个信息中有重复的，有用的信息没有记录下来，为了获取尽可能多的信息，我们对于编号为 $x$ 的点，记录编号最接近的两个距离在 $C$ 以内且满足 $dep_i<dep_x\lor(dep_i=dep_x\land i<x)$ 的点，这样相当于我们给每个条边定向，我们只记录出边中连向点编号最接近 $x$ 的两条边，所以是正确的。

我们注意数据范围，猜想正解复杂度为 $O(n\log^2 n+m\log n)$。

首先，预处理出上面说的这个东西可以用点分治，对于每一个分治中心，我们把点按 $dep$ 排序插入平衡树内，平衡树节点维护到分治中心的 $dis$ 最小值，查询时直接平衡树上二分就可以了。

然后考虑如何处理查询，我们手玩样例后猜测答案是出度为 $0$ 的点，即我们预处理出来的两个点都不在区间内的点，我们只要证明一个连通块内不会存在两个出度为 $0$ 的点即可。

这显然是一个 $\text{DAG}$，并且出度为 $0$ 的点一定是深度最小的点，若存在两个出度为深度最小的点，它们之间一定有边，否则这两个出度为 $0$ 的点不连通。

那么问题转化为每个点有两个属性 $l_i,r_i$，当 $l_i<l\land r_i>r$ 时，$i$ 对询问区间 $[l,r]$ 产生 $1$ 的贡献，直接把询问离线下来用树状数组维护答案就可以了，不会的可以去做 HH 的项链。

代码就不放了，反正也过不去。